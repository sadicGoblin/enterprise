<div class="datatable-container" [ngClass]="{'with-shadow': config.shadow}">
  <div class="datatable-header" *ngIf="columns && columns.length > 0">
    <div class="column-selector" *ngIf="columns.length > 1">
      <button mat-icon-button [matMenuTriggerFor]="columnMenu" matTooltip="{{config.columnSelectLabel}}">
        <mat-icon>view_column</mat-icon>
      </button>
      <mat-menu #columnMenu="matMenu" xPosition="before">
        <div class="column-menu-header">{{config.columnSelectLabel}}</div>
        <button mat-menu-item *ngFor="let column of availableColumns" 
                (click)="$event.stopPropagation(); toggleColumnVisibility(column.field)">
          <mat-checkbox [checked]="visibleColumns.has(column.field)" 
                        (change)="$event.stopPropagation(); toggleColumnVisibility(column.field)">
            {{column.header}}
          </mat-checkbox>
        </button>
      </mat-menu>
    </div>
  </div>

  <div class="table-container" [style.max-height]="config.maxHeight">
    <table mat-table [dataSource]="displayData" matSort (matSortChange)="onSortChange($event)" class="compact-table">
      <!-- Columna de selección -->
      <ng-container matColumnDef="select" *ngIf="config.selectable">
        <th mat-header-cell *matHeaderCellDef class="select-cell">
          <mat-checkbox></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row; let i = index" class="select-cell">
          <mat-checkbox [checked]="isSelected(i)" (change)="onRowSelect($event, row, i)"></mat-checkbox>
        </td>
      </ng-container>

      <!-- Columna de números de fila -->
      <ng-container matColumnDef="rowNum" *ngIf="config.showRowNumber">
        <th mat-header-cell *matHeaderCellDef class="row-num-cell"></th>
        <td mat-cell *matCellDef="let row; let i = index" class="row-num-cell">
          {{ i + 1 + (currentPage * currentPageSize) }}
        </td>
      </ng-container>

      <!-- Columnas dinámicas según configuración -->
      <ng-container *ngFor="let column of columns" [matColumnDef]="column.field">
        <th mat-header-cell *matHeaderCellDef 
            [style.width]="column.width" 
            [style.text-align]="column.align || 'left'"
            [mat-sort-header]="column.sortable ? column.field : null">
          {{ column.header }}
        </th>
        <td mat-cell *matCellDef="let row" 
            [ngClass]="getCellClass(column, formatCellValue(column, row))"
            [style.width]="column.width">
          {{ formatCellValue(column, row) }}
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; let i = index; columns: displayedColumns;"
          (click)="onRowClick(row, i)"
          [ngClass]="{'selected-row': isSelected(i)}"></tr>
    </table>

    <div class="no-data-message" *ngIf="!displayData || displayData.length === 0">
      {{config.noDataMessage}}
    </div>
  </div>

  <mat-paginator *ngIf="config.pagination && totalItems > 0"
                [pageSize]="currentPageSize"
                [pageSizeOptions]="[5, 10, 20, 50, 100]"
                [length]="totalItems"
                [pageIndex]="currentPage"
                (page)="onPageChange($event)"
                showFirstLastButtons>
  </mat-paginator>
</div>
