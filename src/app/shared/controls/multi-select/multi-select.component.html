<div class="multi-select-container">
  <!-- Encabezado expandible del grupo -->
  <div class="group-header" *ngIf="showHeader" (click)="toggleExpand()">
    <div class="header-left">
      <mat-icon [color]="selectedCount > 0 ? 'primary' : ''">{{ groupIcon }}</mat-icon>
      <span>{{ groupName }}</span>
    </div>
    <div class="header-right">
      <span class="badge" *ngIf="selectedCount > 0">{{ selectedCount }}</span>
      <mat-icon class="expand-icon">{{ expanded ? getIconName('collapse') : getIconName('expand') }}</mat-icon>
    </div>
  </div>
  
  <!-- Contenido expandible -->
  <div class="group-content" [class.expanded]="expanded">
    <!-- Etiqueta del componente si se proporciona -->
    <div class="multi-select-header" *ngIf="label">
      <span class="multi-select-label">{{ label }}</span>
      <span class="multi-select-badge" *ngIf="getSelectedCount() > 0">
        {{ getSelectedCount() }}
      </span>
    </div>
    
    <!-- Buscador simple para filtrar la lista con estilo consistente -->
    <div *ngIf="expanded && internalItems.length > 15" class="multi-select-search">
      <div class="custom-input-wrapper">
        <div class="custom-input-container">
          <mat-icon>{{ getIconName('search') }}</mat-icon>
          <input 
            class="custom-input" 
            type="text" 
            [placeholder]="'Buscar elemento...'"
            [formControl]="searchControl">
        </div>
      </div>
    </div>
    
    <!-- Opción Ver todos (fija, fuera del área de scroll) -->
    <div *ngIf="expanded" class="multi-select-all-option-fixed">
      <div class="ver-todos-container">
        <mat-checkbox
          [checked]="isAllSelected()"
          [indeterminate]="getSelectedCount() > 0 && !isAllSelected()"
          (change)="toggleAll()">
        </mat-checkbox>
        <span class="ver-todos-text">VER TODOS</span>
      </div>
    </div>
    
    <!-- Lista de elementos con scroll -->
    <div *ngIf="expanded" class="multi-select-list" [style.maxHeight]="maxHeight">
      <!-- Mostramos los elementos filtrados - todos o limitados a 15 según showAllItems -->
      <ng-container *ngIf="(filteredItems | async) as filteredList">
        <div
          *ngFor="let item of (showAllItems ? filteredList : filteredList.slice(0, 15)); let i = index"
          class="multi-select-option"
          [class.disabled]="item.disabled"
          [class.even-row]="i % 2 === 0"
          [class.odd-row]="i % 2 === 1"
          [class.selected]="item.selected"
          (click)="toggleSelection(item)">
          <mat-checkbox
            [checked]="item.selected"
            [disabled]="item.disabled"
            (change)="toggleSelection(item)"
            (click)="$event.stopPropagation()">
            <span 
              class="checkbox-label custom-font-size" 
              id="checkbox-label-text"
              [matTooltip]="isTextOverflowing(item.label) ? item.label : ''" 
              matTooltipPosition="above"
              style="font-size: 10px !important; font-weight: 500 !important; color: #333 !important; max-width: 240px !important;">
              {{ item.label }}
            </span>
          </mat-checkbox>
          <span class="multi-select-count" *ngIf="showCount && item.count !== undefined">
            ({{ item.count }})
          </span>
        </div>
      </ng-container>
      
      <!-- Mensaje clickeable para mostrar más elementos o colapsar -->
      <ng-container *ngIf="(filteredItems | async) as filteredList">
        <div class="more-elements-indicator" *ngIf="filteredList.length > 15">
          <mat-divider></mat-divider>
          <div class="more-message clickable" (click)="toggleShowAllItems()">
            <mat-icon class="more-icon">{{ showAllItems ? getIconName('collapse') : getIconName('more') }}</mat-icon>
            <span class="more-text">
              {{ showAllItems ? 'Mostrar menos...' : 'Y ' + (filteredList.length - 15) + ' elementos más...' }}
            </span>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</div>
