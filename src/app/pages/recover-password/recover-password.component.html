<div class="recover-container">
  <mat-card class="recover-card">
    <div class="recover-card-header">
      <div class="top-stripes">
        <div class="stripe stripe-blue"></div>
        <div class="stripe stripe-yellow"></div>
      </div>
    </div>

    <div class="recover-card-content">
      <div class="logo">
        <img src="/assets/logo.png" alt="Logo" />
      </div>

      <h2 class="title">Ingresa Nueva Contraseña</h2>
      <p class="subtitle">Ingresa los datos solicitados para recuperar tu contraseña</p>

      <!-- Spinner de validación -->
      <div *ngIf="isValidatingHash" class="validation-spinner">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Validando solicitud...</p>
      </div>

      <!-- Mensaje de error si el hash no es válido -->
      <div *ngIf="!isValidatingHash && !isHashValid && hashErrorMessage" class="error-message">
        <mat-icon class="error-icon">error_outline</mat-icon>
        <p>{{ hashErrorMessage }}</p>
      </div>

      <!-- Mensaje de éxito cuando la contraseña se cambió correctamente -->
      <div *ngIf="passwordChangedSuccessfully" class="success-message">
        <mat-icon class="success-icon">check_circle</mat-icon>
        <h3>¡Contraseña actualizada correctamente!</h3>
        <p>Tu contraseña ha sido cambiada exitosamente. Ya puedes cerrar esta ventana e iniciar sesión con tu nueva contraseña.</p>
      </div>

      <form (ngSubmit)="onSubmit()" #recoverForm="ngForm" *ngIf="!isValidatingHash && !passwordChangedSuccessfully">
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>CONTRASEÑA</mat-label>
          <input
            matInput
            [type]="hidePassword ? 'password' : 'text'"
            name="password"
            [(ngModel)]="password"
            required
            minlength="4"
            placeholder="Mínimo 4 caracteres (2 letras + 2 números)"
            [disabled]="!isHashValid"
          />
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="hidePassword = !hidePassword"
            [attr.aria-label]="'Mostrar contraseña'"
            [attr.aria-pressed]="!hidePassword"
          >
            <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
          <mat-hint>Debe contener al menos 2 letras y 2 números</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>CONFIRMAR CONTRASEÑA</mat-label>
          <input
            matInput
            [type]="hideConfirmPassword ? 'password' : 'text'"
            name="confirmPassword"
            [(ngModel)]="confirmPassword"
            required
            minlength="4"
            placeholder="Confirma tu contraseña"
            [disabled]="!isHashValid"
          />
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="hideConfirmPassword = !hideConfirmPassword"
            [attr.aria-label]="'Mostrar contraseña'"
            [attr.aria-pressed]="!hideConfirmPassword"
          >
            <mat-icon>{{ hideConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
          <mat-hint>Debe coincidir con la contraseña anterior</mat-hint>
        </mat-form-field>

        <button
          mat-raised-button
          class="full-width custom-submit-btn"
          [disabled]="!recoverForm.form.valid || isLoading || !isHashValid"
          type="submit"
        >
          <span *ngIf="!isLoading">Crear Nueva Contraseña</span>
          <div *ngIf="isLoading" class="spinner-container">
            <mat-spinner diameter="24" color="accent"></mat-spinner>
          </div>
        </button>
      </form>
    </div>
  </mat-card>
</div>
