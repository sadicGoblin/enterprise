<div class="map-container">
    <!-- Spinner para carga -->
    <div *ngIf="isLoadingActivities" class="spinner-overlay">
      <mat-spinner></mat-spinner>
    </div>
    
    <div class="map-card-content">
      <div class="form-container">
        <div class="form-row input-row">
          <app-custom-select
            #scopeSelect
            [formControl]="scopeControl"
            [loadFromApi]="true"
            [parameterType]="parameterTypes.CUSTOM_API" 
            [customApiEndpoint]="scopeApiEndpoint"
            [customApiRequestBody]="scopeApiRequestBody"
            [customOptionValueKey]="'IdAmbito'"
            [customOptionLabelKey]="'nombre'"
            label="Ámbito"
            [appearance]="'fill'"
            class="form-field"
            (selectionChange)="onScopeSelectionChange($event)"
          ></app-custom-select>

          <mat-form-field appearance="fill" class="form-field">
            <mat-label>Nombre</mat-label>
            <input matInput [(ngModel)]="activityName" placeholder="Nombre" />
          </mat-form-field>

          <mat-form-field appearance="fill" class="form-field">
            <mat-label>Código</mat-label>
            <input matInput [(ngModel)]="activityCode" placeholder="Código" />
          </mat-form-field>
        </div>

        <div class="form-row input-row">
          <app-custom-select
            [formControl]="frequencyControl"
            [loadFromApi]="true"
            [parameterType]="parameterTypes.CUSTOM_API" 
            [customApiEndpoint]="frequencyApiEndpoint"
            [customApiRequestBody]="frequencyApiRequestBody"
            [customOptionValueKey]="'IdDet'"
            [customOptionLabelKey]="'Nombre'"
            label="Periocidad"
            [appearance]="'fill'"
            class="form-field"
            (selectionChange)="onFrequencySelectionChange($event)"
          ></app-custom-select>

          <app-custom-select
            [formControl]="categoryControl"
            [loadFromApi]="true"
            [parameterType]="parameterTypes.CUSTOM_API" 
            [customApiEndpoint]="categoryApiEndpoint"
            [customApiRequestBody]="categoryApiRequestBody"
            [customOptionValueKey]="'IdDet'"
            [customOptionLabelKey]="'Nombre'"
            label="Categoría Actividad"
            [appearance]="'fill'"
            class="form-field"
            (selectionChange)="onCategorySelectionChange($event)"
          ></app-custom-select>

          <app-custom-select
            [formControl]="parameterControl"
            [loadFromApi]="true"
            [parameterType]="parameterTypes.CUSTOM_API" 
            [customApiEndpoint]="parameterApiEndpoint"
            [customApiRequestBody]="parameterApiRequestBody"
            [customOptionValueKey]="'IdParametro'"
            [customOptionLabelKey]="'Nombre'"
            label="Parámetro Asociado"
            [appearance]="'fill'"
            class="form-field"
            (selectionChange)="onParameterSelectionChange($event)"
          ></app-custom-select>
        </div>

        <div class="form-row input-row">
          <app-custom-select
            [formControl]="documentControl"
            [loadFromApi]="true"
            [parameterType]="parameterTypes.CUSTOM_API" 
            [customApiEndpoint]="documentApiEndpoint"
            [customApiRequestBody]="documentApiRequestBody"
            [customOptionValueKey]="'IdDocumento'"
            [customOptionLabelKey]="'Nombre'"
            label="Documento Asociado"
            [appearance]="'fill'"
            class="form-field"
            (selectionChange)="onDocumentSelectionChange($event)"
          ></app-custom-select>
        </div>

        <div class="form-row button-row action-buttons-right">
          <button 
            mat-stroked-button 
            *ngIf="activityBeingEdited" 
            (click)="cancelEditActivity()"
            class="cancel-button"
          >
            <mat-icon>close</mat-icon> Cancelar
          </button>
          <button 
            mat-raised-button 
            color="primary" 
            (click)="addActivity()" 
            class="add-button"
          >
            <mat-icon>{{ activityBeingEdited ? 'save' : 'add_circle' }}</mat-icon>
            {{ activityBeingEdited ? 'Actualizar' : 'Agregar' }}
          </button>
        </div>
      </div>

      <div class="table-section">
        <div class="table-controls">
          <mat-form-field appearance="fill" class="search-field">
            <mat-label>Buscar</mat-label>
            <input 
              matInput 
              [(ngModel)]="searchActivityValue"
              (keyup)="applyActivitySearchFilter()"
              placeholder="Buscar" 
            />
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>
        
        <table
          mat-table
          [dataSource]="activities"
          class="mat-elevation-z2 full-width-table"
        >
          <ng-container matColumnDef="code">
            <th mat-header-cell *matHeaderCellDef>Código</th>
            <td mat-cell *matCellDef="let element">{{ element.code }}</td>
          </ng-container>

          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Nombre</th>
            <td mat-cell *matCellDef="let element">{{ element.name }}</td>
          </ng-container>

          <ng-container matColumnDef="frequency">
            <th mat-header-cell *matHeaderCellDef>Frecuencia</th>
            <td mat-cell *matCellDef="let element">
              {{ element.frequency }}
            </td>
          </ng-container>

          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef>Categoría</th>
            <td mat-cell *matCellDef="let element">{{ element.category }}</td>
          </ng-container>

          <ng-container matColumnDef="parameter">
            <th mat-header-cell *matHeaderCellDef>Parámetro</th>
            <td mat-cell *matCellDef="let element">
              {{ element.parameter }}
            </td>
          </ng-container>

          <ng-container matColumnDef="document">
            <th mat-header-cell *matHeaderCellDef>Documento</th>
            <td mat-cell *matCellDef="let element">{{ element.document }}</td>
          </ng-container>

          <!-- Separated action columns for better button layout -->
          <ng-container matColumnDef="edit">
            <th mat-header-cell *matHeaderCellDef class="action-cell">Editar</th>
            <td mat-cell *matCellDef="let element; let i = index" class="action-cell">
              <button mat-icon-button color="primary" (click)="editActivity(i)">
                <mat-icon>edit</mat-icon>
              </button>
            </td>
          </ng-container>

          <ng-container matColumnDef="delete">
            <th mat-header-cell *matHeaderCellDef class="action-cell">Eliminar</th>
            <td mat-cell *matCellDef="let element; let i = index" class="action-cell">
              <button mat-icon-button color="warn" (click)="deleteActivity(i)">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumnsActivities"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumnsActivities"
          ></tr>
        </table>
        
        <div *ngIf="activities.length === 0" class="empty-state">
          <mat-icon>info</mat-icon>
          <p>No se encontraron actividades o no se ha seleccionado un Ámbito</p>
        </div>
        
        <div class="save-button-container" *ngIf="activities.length > 0">
          <button mat-flat-button color="accent" (click)="saveActivity()" class="save-button">
            <mat-icon>save</mat-icon> Guardar
          </button>
        </div>
      </div>
    </div>
</div>
