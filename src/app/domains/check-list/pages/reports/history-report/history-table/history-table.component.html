<!-- Sección de filtros y búsqueda -->
<div class="search-filter-container">
  <!-- Búsqueda global -->
  <div class="global-search">
    <div class="custom-input-wrapper">
      <label class="custom-label">Búsqueda global</label>
      <div class="custom-input-container">
        <mat-icon>search</mat-icon>
        <input class="custom-input" (keyup)="applyGlobalFilter($event)" placeholder="Buscar en todos los campos">
      </div>
    </div>
    <button mat-icon-button color="primary" (click)="clearGlobalFilter()" aria-label="Limpiar búsqueda" class="clear-search" *ngIf="globalFilterValue" matTooltip="Limpiar búsqueda">
      <mat-icon>close</mat-icon>
    </button>
  </div>
  
  <!-- Filtros en una sola fila -->
  <div class="filters-row">
    <!-- Filtro Obra -->
    <div class="custom-select-wrapper filter-field">
      <label class="custom-label">Obra</label>
      <div class="custom-input-container">
        <mat-icon>business</mat-icon>
        <mat-select #obraSelect class="custom-select" multiple [(value)]="selectedObras" (selectionChange)="applyFilterObra($event.value)" placeholder="Seleccionar obra" panelClass="small-select-panel" (openedChange)="adjustPanelHeight(obraSelect, $event)">
          <div class="select-actions">
            <button mat-icon-button (click)="selectAllOptions('Obra')" matTooltip="Seleccionar todos">
              <mat-icon>done_all</mat-icon>
            </button>
            <button mat-icon-button (click)="clearFilterSingle('Obra')" matTooltip="Deseleccionar todos">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <mat-option *ngFor="let obra of filtroObras" [value]="obra">{{ obra }}</mat-option>
        </mat-select>
      </div>
    </div>
    
    <!-- Filtro Usuario -->
    <div class="custom-select-wrapper filter-field">
      <label class="custom-label">Usuario</label>
      <div class="custom-input-container">
        <mat-icon>person</mat-icon>
        <mat-select #usuarioSelect class="custom-select" multiple [(value)]="selectedUsuarios" (selectionChange)="applyFilterUsuario($event.value)" placeholder="Seleccionar usuario" panelClass="small-select-panel" (openedChange)="adjustPanelHeight(usuarioSelect, $event)">
          <div class="select-actions">
            <button mat-icon-button (click)="selectAllOptions('Usuario')" matTooltip="Seleccionar todos">
              <mat-icon>done_all</mat-icon>
            </button>
            <button mat-icon-button (click)="clearFilterSingle('Usuario')" matTooltip="Deseleccionar todos">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <mat-option *ngFor="let usuario of filtroUsuarios" [value]="usuario">{{ usuario }}</mat-option>
        </mat-select>
      </div>
    </div>
    
    <!-- Filtro Tipo -->
    <div class="custom-select-wrapper filter-field">
      <label class="custom-label">Tipo</label>
      <div class="custom-input-container">
        <mat-icon>label</mat-icon>
        <mat-select #tipoSelect class="custom-select" multiple [(value)]="selectedTipos" (selectionChange)="applyFilterTipo($event.value)" placeholder="Seleccionar tipo" panelClass="small-select-panel" (openedChange)="adjustPanelHeight(tipoSelect, $event)">
          <div class="select-actions">
            <button mat-icon-button (click)="selectAllOptions('Tipo')" matTooltip="Seleccionar todos">
              <mat-icon>done_all</mat-icon>
            </button>
            <button mat-icon-button (click)="clearFilterSingle('Tipo')" matTooltip="Deseleccionar todos">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <mat-option *ngFor="let tipo of filtroTipos" [value]="tipo">{{ tipo }}</mat-option>
        </mat-select>
      </div>
    </div>
    
    <!-- Filtro Estado -->
    <div class="custom-select-wrapper filter-field">
      <label class="custom-label">Estado</label>
      <div class="custom-input-container">
        <mat-icon>check_circle</mat-icon>
        <mat-select #estadoSelect class="custom-select" multiple [(value)]="selectedEstados" (selectionChange)="applyFilterEstado($event.value)" placeholder="Seleccionar estado" panelClass="small-select-panel" (openedChange)="adjustPanelHeight(estadoSelect, $event)">
          <div class="select-actions">
            <button mat-icon-button (click)="selectAllOptions('Estado')" matTooltip="Seleccionar todos">
              <mat-icon>done_all</mat-icon>
            </button>
            <button mat-icon-button (click)="clearFilterSingle('Estado')" matTooltip="Deseleccionar todos">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <mat-option *ngFor="let estado of filtroEstados" [value]="estado">{{ estado }}</mat-option>
        </mat-select>
      </div>
    </div>
  </div>
  
  <div class="filter-actions">
    <button mat-icon-button color="primary" (click)="clearFilters()" matTooltip="Limpiar filtros" [disabled]="!hasActiveFilters()">
      <mat-icon>filter_list_off</mat-icon>
    </button>
    <button mat-icon-button class="excel-button" (click)="exportToExcel()" matTooltip="Exportar a Excel" [disabled]="!dataSource.data.length">
      <mat-icon>file_download</mat-icon>
    </button>
  </div>
</div>

<!-- Tabla de datos -->
<div class="table-container">
  <table mat-table [dataSource]="dataSource" class="results-table" matSort>
  
    <!-- Fecha -->
    <ng-container matColumnDef="fecha">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
      <td mat-cell *matCellDef="let element">{{ element.fecha }}</td>
    </ng-container>
    
    <!-- Obra -->
    <ng-container matColumnDef="Obra">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Obra</th>
      <td mat-cell *matCellDef="let element">{{ element.Obra }}</td>
    </ng-container>
    
    <!-- Usuario -->
    <ng-container matColumnDef="Usuario">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Usuario</th>
      <td mat-cell *matCellDef="let element">{{ element.Usuario }}</td>
    </ng-container>
    
    <!-- Actividad -->
    <ng-container matColumnDef="Actividad">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Actividad</th>
      <td mat-cell *matCellDef="let element">{{ element.Actividad }}</td>
    </ng-container>
    
    <!-- Tipo -->
    <ng-container matColumnDef="tipo">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
      <td mat-cell *matCellDef="let element">{{ element.tipo }}</td>
    </ng-container>
    
    <!-- Estado -->
    <ng-container matColumnDef="estado">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
      <td mat-cell *matCellDef="let element">
        <span [ngClass]="{
          'estado-cumplida': element.estado === 'cumplida',
          'estado-no-cumplida': element.estado === 'no cumplida'
        }">{{ element.estado }}</span>
      </td>
    </ng-container>
    
    <!-- Cargo -->
    <ng-container matColumnDef="cargo">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Cargo</th>
      <td mat-cell *matCellDef="let element">{{ element.cargo }}</td>
    </ng-container>
    
    <!-- Subproceso -->
    <ng-container matColumnDef="subproceso">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Subproceso</th>
      <td mat-cell *matCellDef="let element">{{ element.subproceso }}</td>
    </ng-container>
    
    <!-- No se incluye columna de acciones por requerimiento del usuario -->
    
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    
    <!-- Fila para mostrar cuando no hay datos -->
    <tr class="mat-row" *matNoDataRow>
      <td class="mat-cell" colspan="6">
        No hay datos para mostrar.
      </td>
    </tr>
  </table>
  
  <div class="paginator-container">
    <mat-paginator [pageSizeOptions]="[15, 30, 50, 100]" [pageSize]="15" showFirstLastButtons></mat-paginator>
  </div>
</div>
