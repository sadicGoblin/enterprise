<div class="chart-card kpi-dashboard-card" #chartContainer>
  <ng-container *ngIf="hasData; else noData">
    <!-- Encabezado con título e indicador KPI -->
    <div class="chart-header">
      <div class="title-container">
        <div class="chart-title">
          <mat-icon>bar_chart</mat-icon>
          <h3 *ngIf="!isEditingTitle" 
              (dblclick)="startEditingTitle()" 
              class="editable-title"
              matTooltip="Doble click para editar" matTooltipPosition="above">
            {{ title }}
          </h3>
          <input *ngIf="isEditingTitle"
                 type="text"
                 [(ngModel)]="editableTitle"
                 (keydown)="onTitleKeydown($event)"
                 (blur)="saveTitleEdit()"
                 class="title-input"
                 maxlength="50">
        </div>
        <div class="action-buttons">
          <button mat-icon-button (click)="exportToPNG()" class="export-button" matTooltip="Exportar como PNG" matTooltipPosition="above">
            <mat-icon style="font-size: 20px; vertical-align: middle; color: white;">download</mat-icon>
          </button>
          <button mat-icon-button (click)="openDetailsPopup()" class="details-button" matTooltip="Ver datos filtrados" matTooltipPosition="above">
            <mat-icon style="font-size: 20px; vertical-align: middle; color: white;">grid_on</mat-icon>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Contenido del gráfico -->
    <!-- Eliminamos restricciones de contenedor para permitir altura dinámica -->
    <div class="chart-content" style="height: auto;">
      <div class="chart-canvas-container" style="height: auto;">
        <canvas #chartCanvas style="min-height: 200px;"></canvas>
      </div>
    </div>
    
    <!-- Footer con estadísticas -->
    <div class="chart-footer" *ngIf="hasData">
      <div class="stats-container">
        <div class="stats-left">
          <span class="stat-item total-filtro" *ngIf="filterType">
            <span class="stat-label">Total {{filterType}}:</span>
            <span class="stat-value">{{totalFiltro}}</span>
          </span>
          <span class="stat-divider" *ngIf="filterType">|</span>
          <span class="stat-item">
            <span class="stat-label">Registros:</span>
            <span class="stat-value">{{totalElementos}}</span>
          </span>
        </div>
        
        <div class="stats-right">
          <ng-container *ngFor="let estado of estados; let i = index; let isLast = last">
            <span class="stat-item">
              <span class="stat-label">{{estado}}:</span>
              <span class="stat-value" [style.color]="getEstadoColor(estado, i)">{{contadorEstados[estado] || 0}}</span>
            </span>
            <span class="stat-divider" *ngIf="!isLast">|</span>
          </ng-container>
        </div>
      </div>
    </div>
    
    <!-- Nueva sección de tabla mensual -->
    <div class="monthly-table-container" *ngIf="hasData">
      <div class="monthly-table-header">
        <h4>Datos por Mes</h4>
      </div>
      <div class="monthly-table-content">
        <table class="monthly-data-table">
          <thead>
            <tr>
              <th class="row-header">{{yAxisLabel || 'Ítem'}}</th>
              <ng-container *ngFor="let month of monthsInRange">
                <th>{{month}}</th>
              </ng-container>
              <th class="total-column">{{reportConfig?.unit === 'quantity' ? 'TOTAL' : 'PROMEDIO TOTAL'}}</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let row of monthlyTableData">
              <tr [class.total-row]="row.isTotal">
                <th class="row-header" [class.total-row-header]="row.isTotal">{{row.name}}</th>
                <ng-container *ngFor="let month of monthsInRange">
                  <td [ngClass]="getValueClass(row[month])" [class.total-cell]="row.isTotal">
                    <ng-container *ngIf="row[month] !== null && row[month] !== undefined">
                      <!-- Caso para valor de objeto (con tooltip) -->
                      <span *ngIf="row[month]?.percent" 
                            [matTooltip]="row[month].tooltip"
                            matTooltipPosition="above">
                        {{row[month].displayValue | number:'1.0-0'}}%
                      </span>
                      <!-- Caso para valor simple -->
                      <ng-container *ngIf="!row[month]?.percent">
                        {{row[month] | number:'1.0-0'}}{{reportConfig?.unit === 'percent' ? '%' : ''}}
                      </ng-container>
                    </ng-container>
                    <ng-container *ngIf="row[month] === null || row[month] === undefined">
                      -
                    </ng-container>
                  </td>
                </ng-container>
                <td class="total-column" [class.total-cell]="row.isTotal">{{row.average | number:'1.0-0'}}{{reportConfig?.unit === 'percent' ? '%' : ''}}</td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>

  </ng-container>
  
  <ng-template #noData>
    <div class="no-data-container">
      <mat-icon>info</mat-icon>
      <span>No hay datos disponibles para mostrar</span>
    </div>
  </ng-template>
</div>
