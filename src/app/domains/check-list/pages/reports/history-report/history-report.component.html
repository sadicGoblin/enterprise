<div class="map-container">
  <mat-card class="map-card">
    <div *ngIf="isLoading" class="spinner-overlay">
      <div class="loading-container">
        <mat-spinner></mat-spinner>
        <p class="loading-text">
          {{
            isRetrying
              ? "Reintentando llamada al servicio..."
              : "Procesando la información..."
          }}
        </p>
      </div>
    </div>

    <div class="map-card-header">
      <h2 class="title">Reporte Histórico</h2>

      <!-- Icono del carrito de exportación -->
      <button
        mat-icon-button
        class="export-cart-btn"
        (click)="toggleExportCart()"
        [class.has-items]="exportCartCount > 0"
        matTooltip="Carrito de exportación ({{ exportCartCount }} elementos)"
        style="visibility: hidden"
      >
        <mat-icon>shopping_cart</mat-icon>
        <span class="cart-badge" *ngIf="exportCartCount > 0">{{
          exportCartCount
        }}</span>
      </button>
    </div>

    <div class="map-card-content">
      <!-- Formulario de filtros -->
      <div class="form-container compact">
        <div class="form-header">
          <h3>
            <mat-icon class="header-icon">filter_alt</mat-icon>
            <span *ngIf="isFilterExpanded">Búsqueda por rangos</span>
            <div
              *ngIf="!isFilterExpanded && selectedDateRange"
              class="date-range-summary"
            >
              <div class="report-type-line">
                {{ getSelectedReportTypeLabel() }}
              </div>
              <div class="date-range-line">
                {{ formatDateForDisplay(historyForm.value.startDate) }} -
                {{ formatDateForDisplay(historyForm.value.endDate) }}
              </div>
            </div>
          </h3>
          <span class="icon-container">
            <button
              mat-icon-button
              class="expand-button"
              (click)="toggleFilterVisibility()"
              type="button"
              aria-label="Expandir/colapsar"
            >
              <mat-icon *ngIf="isFilterExpanded">expand_less</mat-icon>
              <mat-icon *ngIf="!isFilterExpanded">expand_more</mat-icon>
            </button>
          </span>
        </div>
        <mat-divider></mat-divider>

        <div
          class="filter-content"
          [ngClass]="{ collapsed: !isFilterExpanded }"
        >
          <form [formGroup]="historyForm" (ngSubmit)="onSubmit()">
            <!-- Selector de tipo de reporte -->
            <div class="form-field-container">
              <div class="form-field-label">Tipo de Reporte</div>
              <mat-form-field appearance="outline" class="compact-select">
                <mat-select formControlName="reportType">
                  <mat-option
                    *ngFor="let option of reportTypeOptions"
                    [value]="option.value"
                  >
                    {{ option.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <div
                class="field-error"
                *ngIf="
                  historyForm.get('reportType')?.hasError('required') &&
                  historyForm.get('reportType')?.touched
                "
              >
                Requerido
              </div>
            </div>

            <div class="dates-container">
              <div class="date-field-container">
                <div class="date-label">Fecha Desde</div>
                <div class="custom-date-input">
                  <input
                    matInput
                    [matDatepicker]="startPicker"
                    formControlName="startDate"
                    placeholder="dd/mm/aaaa"
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="startPicker"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #startPicker></mat-datepicker>
                </div>
                <div
                  class="field-error"
                  *ngIf="
                    historyForm.get('startDate')?.hasError('required') &&
                    historyForm.get('startDate')?.touched
                  "
                >
                  Requerido
                </div>
              </div>

              <div class="date-field-container">
                <div class="date-label">Fecha Hasta</div>
                <div class="custom-date-input">
                  <input
                    matInput
                    [matDatepicker]="endPicker"
                    formControlName="endDate"
                    placeholder="dd/mm/aaaa"
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="endPicker"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #endPicker></mat-datepicker>
                </div>
                <div
                  class="field-error"
                  *ngIf="
                    historyForm.get('endDate')?.hasError('required') &&
                    historyForm.get('endDate')?.touched
                  "
                >
                  Requerido
                </div>
              </div>
            </div>

            <div class="buttons-row">
              <button
                mat-stroked-button
                type="button"
                class="compact-button"
                (click)="resetForm()"
              >
                <mat-icon class="small-icon">refresh</mat-icon> Limpiar
              </button>
              <button
                mat-raised-button
                color="primary"
                class="compact-button"
                type="submit"
              >
                <mat-icon class="small-icon">description</mat-icon> Generar
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Sistema de mensajes -->
      <app-message
        *ngIf="showMessage"
        [text]="errorMessage"
        [type]="messageType"
        [technicalDetails]="technicalDetails"
        [dismissible]="true"
        [timeout]="7000"
        class="message-block"
      ></app-message>

      <!-- Resultados con pestañas -->
      <div *ngIf="tableData.length > 0" class="results-container compact">
        <!-- Pestañas para Métricas y Datos -->
        <mat-tab-group>
          <mat-tab label="Métricas">
            <app-history-metrics
              [data]="tableData"
              [reportConfig]="reportConfig"
            ></app-history-metrics>
          </mat-tab>
          <mat-tab label="Datos">
            <app-history-table
              [data]="tableData"
              [reportConfig]="reportConfig"
            ></app-history-table>
          </mat-tab>
        </mat-tab-group>
      </div>
    </div>
  </mat-card>
</div>

<!-- Sidebar del carrito de exportación -->
<div class="export-cart-sidebar" [class.open]="isExportCartOpen">
  <div class="cart-overlay" (click)="closeExportCart()"></div>
  <div class="cart-content">
    <div class="cart-header">
      <h3>
        <mat-icon>shopping_cart</mat-icon>
        Carrito de Exportación
      </h3>
      <button mat-icon-button (click)="closeExportCart()" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="cart-body">
      <app-export-selector
        [exportableItems]="exportableItems"
        [externalSelectedIds]="getSelectedElements()"
        [externalSelectedOrder]="selectedElementsOrder"
        [showToolbar]="true"
        [showSelectedPanel]="true"
        toolbarTitle="Elementos para Exportar"
        selectedPanelTitle="Arrastra para reordenar:"
        (exportModeChange)="onExportModeChange($event)"
        (selectionChange)="onSelectionChange($event)"
        (exportRequested)="onExportRequested($event)"
        (orderChange)="onOrderChange($event)"
      >
      </app-export-selector>
    </div>
  </div>
</div>
