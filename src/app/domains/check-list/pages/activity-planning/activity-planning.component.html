<div class="container">
  <mat-card class="mat-container">
    <h2 class="title">Planificación Actividades</h2>

    <div class="filters-container">
      <app-custom-select
        label="Proyecto"
        [formControl]="projectControl"
        [parameterType]="projectParameterType"
        [loadFromApi]="true"
        [customApiEndpoint]="projectApiEndpoint"
        [customApiRequestBody]="projectApiRequestBody"
        [customOptionValueKey]="projectOptionValue"
        [customOptionLabelKey]="projectOptionLabel"
        (selectionChange)="onProjectSelectionChange($event)"
        placeholder="Seleccionar Proyecto"
        [required]="true"
        appearance="fill"
      ></app-custom-select>

      <app-custom-select
        #collaboratorSelect
        label="Colaborador"
        [formControl]="collaboratorControl"
        [parameterType]="collaboratorParameterType"
        [loadFromApi]="true"
        [customApiEndpoint]="collaboratorApiEndpoint"
        [customApiRequestBody]="collaboratorApiRequestBody"
        [customOptionValueKey]="collaboratorOptionValue"
        [customOptionLabelKey]="collaboratorOptionLabel"
        (selectionChange)="onCollaboratorSelectionChange($event)"
        placeholder="Seleccionar Colaborador"
        appearance="fill"
      ></app-custom-select>

      <mat-form-field appearance="fill">
        <mat-label>Periodo</mat-label>
        <input 
          matInput 
          [matDatepicker]="picker" 
          [(ngModel)]="selectedPeriod" 
          [value]="selectedPeriod"
          (dateChange)="onPeriodChange($event)"
          [placeholder]="formattedPeriod || 'MM/YYYY'"
          readonly
        />
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker
          #picker
          startView="multi-year"
          [startAt]="selectedPeriod"
          (monthSelected)="setMonthAndYear($event, picker)"
          panelClass="month-picker"
        ></mat-datepicker>
      </mat-form-field>

      <div class="button-container">
        <button mat-raised-button color="primary" class="consultar-btn">
          <mat-icon>search</mat-icon>
          Consultar
        </button>
      </div>
    </div>

    <!-- New horizontal calendar implementation -->
    <div class="section-separator"></div>
    <div class="cronograma-header">
      <h3>PLANIFICACIÓN MENSUAL</h3>
    </div>
    
    <div class="horizontal-calendar-container">
      
      <div class="horizontal-calendar-wrapper">
        <table class="horizontal-calendar-table mat-elevation-z2">
          <!-- Header Row -->
          <tr class="calendar-header-row weekday-row">
            <th class="sticky-column activity-column">Actividad</th>
            <th class="sticky-column periodicity-column">Período</th>
            <th *ngFor="let day of days" class="day-column" [ngClass]="{'weekend-column': isWeekend(day)}">
              <div class="weekday-label">{{ getDayOfWeekAbbr(day) }}</div>
              <div class="day-number">{{ day < 10 ? '0' + day : day }}</div>
            </th>
          </tr>
          
          <!-- Activity Rows -->
          <tr *ngFor="let activity of activities" class="calendar-row">
            <td class="sticky-column activity-column">{{ activity.name }}</td>
            <td class="sticky-column periodicity-column">
              {{ activity.periodicity === 'SEMANAL' ? 'Semanal' : 
                 activity.periodicity === 'QUINCENAL' ? 'Quincenal' : 'Mensual' }}
            </td>
            <td *ngFor="let day of days" class="day-column checkbox-cell" 
                [ngClass]="{'day-scheduled': activity.scheduledDays.includes(day), 'weekend-column': isWeekend(day)}">
              <mat-checkbox
                [checked]="activity.scheduledDays.includes(day)"
                (change)="toggleScheduledDay(activity, day, $event.checked)"
                [color]="'primary'"
              ></mat-checkbox>
            </td>
          </tr>
        </table>
      </div>
      
      <div class="table-actions">
        <button mat-raised-button color="primary" (click)="saveAllChanges()">
          <mat-icon>save</mat-icon> Guardar Cambios
        </button>
      </div>
    </div>

    <div class="cronograma-header">
      <h3>DETALLE CRONOGRAMA MENSUAL</h3>
    </div>
    
    <!-- Original expandable rows implementation -->
    <div class="table-scroll">
      <table mat-table [dataSource]="activities" class="mat-elevation-z2 custom-table compact-table full-width">
        <!-- Expand/collapse column -->
        <ng-container matColumnDef="expand">
          <th mat-header-cell *matHeaderCellDef style="width: 40px;"></th>
          <td mat-cell *matCellDef="let element" style="width: 40px;">
            <button mat-icon-button (click)="toggleRow(element, $event)">
              <mat-icon>
                {{expandedRows.includes(element) ? 'keyboard_arrow_down' : 'keyboard_arrow_right'}}
              </mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Actividad</th>
          <td mat-cell *matCellDef="let element" class="activity-cell">{{ element.name }}</td>
        </ng-container>

        <!-- Periodicity Column -->
        <ng-container matColumnDef="periodicity">
          <th mat-header-cell *matHeaderCellDef class="small-header">Peri.</th>
          <td mat-cell *matCellDef="let element" class="small-cell">
            {{ element.periodicity === 'SEMANAL' ? 'Semanal' : 
               element.periodicity === 'QUINCENAL' ? 'Quincenal' : 'Mensual' }}
          </td>
        </ng-container>

        <!-- Assigned Column -->
        <ng-container matColumnDef="assigned">
          <th mat-header-cell *matHeaderCellDef class="small-header">Asigna.</th>
          <td mat-cell *matCellDef="let element" class="numeric-cell">{{ element.assigned }}</td>
        </ng-container>

        <!-- Realized Column -->
        <ng-container matColumnDef="realized">
          <th mat-header-cell *matHeaderCellDef class="small-header">Realiz.</th>
          <td mat-cell *matCellDef="let element" class="numeric-cell">{{ element.realized }}</td>
        </ng-container>

        <!-- Compliance Column -->
        <ng-container matColumnDef="compliance">
          <th mat-header-cell *matHeaderCellDef class="small-header">% Cump.</th>
          <td mat-cell *matCellDef="let element" class="numeric-cell compliance-cell">{{ element.compliance }}%</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let element; columns: displayedColumns;"
            class="activity-row"
            [class.expanded-row]="expandedRows.includes(element)"></tr>
      </table>
      
      <!-- Expanded detail sections - one for each expanded activity -->
      <div *ngFor="let activity of expandedRows" class="activity-detail-container mat-elevation-z1" [@detailExpand]="'expanded'">
        <h4>Calendario Mensual: {{ activity.name }}</h4>
        
        <div class="calendar-grid">
          <!-- Calendar header with weekday names -->
          <div class="calendar-header">
            <div *ngFor="let dayName of dayNames" class="weekday-name">
              <span>{{ dayName }}</span>
            </div>
          </div>
          
          <!-- Calendar body with weeks -->
          <div class="calendar-body">
            <ng-container *ngFor="let week of calendarWeeks">
              <div *ngFor="let day of week" class="calendar-day" 
                   [ngClass]="{
                     'day-scheduled': day && activity.scheduledDays.includes(day),
                     'day-weekend': day && isWeekend(day),
                     'day-empty': day === null
                   }">
                <ng-container *ngIf="day !== null">
                  <mat-checkbox
                    [checked]="activity.scheduledDays.includes(day)"
                    (change)="toggleScheduledDay(activity, day, $event.checked)"
                    class="check-cell"
                    [color]="'primary'"
                  ></mat-checkbox>
                  <span class="day-number">{{ day < 10 ? '0' + day : day }}</span>
                </ng-container>
              </div>
            </ng-container>
          </div>
        </div>
        
        <div class="detail-actions">
          <button mat-raised-button color="primary" (click)="saveActivityChanges(activity)">
            <mat-icon>save</mat-icon> Guardar Cambios
          </button>
        </div>
      </div>
    </div>
  </mat-card>
</div>
