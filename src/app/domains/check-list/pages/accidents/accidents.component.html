<div class="accidents-container">
  <!-- Header con navegación -->
  <div class="page-header">
    <div class="header-left">
      <mat-icon class="header-icon">report_problem</mat-icon>
      <div class="header-text">
        <h1>Registro de Accidente</h1>
        <p>Complete la información del accidente laboral</p>
      </div>
    </div>
    <div class="header-actions">
      <button mat-stroked-button (click)="goToList()">
        <mat-icon>list</mat-icon>
        Ver Listado
      </button>
      <button mat-stroked-button (click)="goToStatistics()">
        <mat-icon>analytics</mat-icon>
        Estadísticas
      </button>
    </div>
  </div>

  <!-- Progress Steps -->
  <div class="steps-container">
    <div class="step" [class.active]="currentStep === 0" [class.completed]="currentStep > 0" (click)="currentStep = 0">
      <div class="step-number">1</div>
      <span class="step-label">Datos del Accidente</span>
    </div>
    <div class="step-connector" [class.completed]="currentStep > 0"></div>
    <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1" (click)="currentStep = 1">
      <div class="step-number">2</div>
      <span class="step-label">Trabajador</span>
    </div>
    <div class="step-connector" [class.completed]="currentStep > 1"></div>
    <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2" (click)="currentStep = 2">
      <div class="step-number">3</div>
      <span class="step-label">Línea de Mando</span>
    </div>
    <div class="step-connector" [class.completed]="currentStep > 2"></div>
    <div class="step" [class.active]="currentStep === 3" [class.completed]="currentStep > 3" (click)="currentStep = 3">
      <div class="step-number">4</div>
      <span class="step-label">Análisis</span>
    </div>
    <div class="step-connector" [class.completed]="currentStep > 3"></div>
    <div class="step" [class.active]="currentStep === 4" [class.completed]="currentStep > 4" (click)="currentStep = 4">
      <div class="step-number">5</div>
      <span class="step-label">Controles</span>
    </div>
  </div>

  <mat-card class="form-card">
    <form [formGroup]="accidentForm" (ngSubmit)="onSubmit()">
      
      <!-- PASO 1: Datos del Accidente -->
      <div class="step-content" *ngIf="currentStep === 0">
        <div class="section-header">
          <mat-icon>description</mat-icon>
          <h2>Datos Principales del Accidente</h2>
        </div>

        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Obra / Proyecto *</mat-label>
            <mat-select formControlName="obra">
              <mat-option *ngFor="let obra of obraOptions" [value]="obra.id">
                {{ obra.nombre }}
              </mat-option>
            </mat-select>
            <mat-error>{{ getErrorMessage('obra') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Empresa *</mat-label>
            <mat-select formControlName="empresa">
              <mat-option *ngFor="let emp of empresaOptions" [value]="emp.id">
                {{ emp.nombre }}
              </mat-option>
            </mat-select>
            <mat-error>{{ getErrorMessage('empresa') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Tipo de Accidente *</mat-label>
            <mat-select formControlName="tipoAccidente">
              <mat-option *ngFor="let tipo of tipoAccidenteOptions" [value]="tipo">
                {{ tipo }}
              </mat-option>
            </mat-select>
            <mat-error>{{ getErrorMessage('tipoAccidente') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>N° Accidente *</mat-label>
            <input matInput type="number" formControlName="numAccidente" min="1">
            <mat-error>{{ getErrorMessage('numAccidente') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Fecha del Accidente *</mat-label>
            <input matInput [matDatepicker]="fechaAccPicker" formControlName="fechaAccidente">
            <mat-datepicker-toggle matSuffix [for]="fechaAccPicker"></mat-datepicker-toggle>
            <mat-datepicker #fechaAccPicker></mat-datepicker>
            <mat-error>{{ getErrorMessage('fechaAccidente') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Hora del Accidente *</mat-label>
            <input matInput type="time" formControlName="horaAccidente">
            <mat-error>{{ getErrorMessage('horaAccidente') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Días Perdidos Estimados</mat-label>
            <input matInput type="number" formControlName="diasPerdidosEstimados" min="0">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Fecha Control/Alta</mat-label>
            <input matInput [matDatepicker]="fechaCtrlPicker" formControlName="fechaControl">
            <mat-datepicker-toggle matSuffix [for]="fechaCtrlPicker"></mat-datepicker-toggle>
            <mat-datepicker #fechaCtrlPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Días Perdidos Final</mat-label>
            <input matInput type="number" formControlName="diasPerdidosFinal" min="0">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>N° Enfermedad Profesional</mat-label>
            <input matInput type="number" formControlName="numEnfermedadProfesional">
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Descripción del Accidente *</mat-label>
          <textarea matInput formControlName="descripcion" rows="4" 
                    placeholder="Describa detalladamente cómo ocurrió el accidente..."></textarea>
          <mat-hint>Mínimo 10 caracteres</mat-hint>
          <mat-error>{{ getErrorMessage('descripcion') }}</mat-error>
        </mat-form-field>
      </div>

      <!-- PASO 2: Datos del Trabajador -->
      <div class="step-content" *ngIf="currentStep === 1">
        <div class="section-header">
          <mat-icon>person</mat-icon>
          <h2>Antecedentes del Trabajador</h2>
        </div>

        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>RUT *</mat-label>
            <input matInput formControlName="trabajadorRut" placeholder="12.345.678-9">
            <mat-error>{{ getErrorMessage('trabajadorRut') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="span-2">
            <mat-label>Nombre Completo *</mat-label>
            <input matInput formControlName="trabajadorNombre" placeholder="Nombre y apellidos">
            <mat-error>{{ getErrorMessage('trabajadorNombre') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Edad *</mat-label>
            <input matInput type="number" formControlName="trabajadorEdad" min="18" max="80">
            <span matSuffix>años</span>
            <mat-error>{{ getErrorMessage('trabajadorEdad') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Cargo *</mat-label>
            <mat-select formControlName="trabajadorCargo">
              <mat-option *ngFor="let cargo of cargoOptions" [value]="cargo">
                {{ cargo }}
              </mat-option>
            </mat-select>
            <mat-error>{{ getErrorMessage('trabajadorCargo') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Día de la Semana *</mat-label>
            <mat-select formControlName="trabajadorDia">
              <mat-option *ngFor="let dia of diaSemanaOptions" [value]="dia">
                {{ dia }}
              </mat-option>
            </mat-select>
            <mat-error>{{ getErrorMessage('trabajadorDia') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Horario</mat-label>
            <input matInput formControlName="trabajadorHorario" placeholder="Ej: 18:30hrs">
          </mat-form-field>
        </div>
      </div>

      <!-- PASO 3: Línea de Mando -->
      <div class="step-content" *ngIf="currentStep === 2">
        <div class="section-header">
          <mat-icon>supervisor_account</mat-icon>
          <h2>Línea de Mando</h2>
        </div>

        <div class="form-grid cols-2">
          <mat-form-field appearance="outline">
            <mat-label>Supervisor *</mat-label>
            <input matInput formControlName="supervisor" placeholder="Nombre del supervisor">
            <mat-error>{{ getErrorMessage('supervisor') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Profesional Terreno</mat-label>
            <input matInput formControlName="pTerreno" placeholder="P. Terreno">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>APR</mat-label>
            <input matInput formControlName="apr" placeholder="Nombre APR">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>ADO</mat-label>
            <input matInput formControlName="ado" placeholder="Nombre ADO">
          </mat-form-field>
        </div>

        <div class="info-card">
          <mat-icon>info</mat-icon>
          <p>Ingrese los nombres de las personas responsables en la línea de mando al momento del accidente.</p>
        </div>
      </div>

      <!-- PASO 4: Análisis / Tipología -->
      <div class="step-content" *ngIf="currentStep === 3">
        <div class="section-header">
          <mat-icon>analytics</mat-icon>
          <h2>Análisis / Tipología</h2>
        </div>

        <div class="form-grid cols-2">
          <mat-form-field appearance="outline">
            <mat-label>Calificación Potencial/Severidad *</mat-label>
            <mat-select formControlName="calificacionPS">
              <mat-option *ngFor="let calif of calificacionPSOptions" [value]="calif">
                {{ calif }}
              </mat-option>
            </mat-select>
            <mat-error>{{ getErrorMessage('calificacionPS') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Fuente</mat-label>
            <input matInput formControlName="fuente" placeholder="Ej: Línea de media tensión">
          </mat-form-field>

          <mat-form-field appearance="outline" class="span-2">
            <mat-label>Acción</mat-label>
            <input matInput formControlName="accion" placeholder="Ej: posicionarse con herramienta manual bajo cables">
          </mat-form-field>

          <mat-form-field appearance="outline" class="span-2">
            <mat-label>Condición</mat-label>
            <input matInput formControlName="condicion" placeholder="Ej: Falta de limitación física sobre cables">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Máquina</mat-label>
            <input matInput formControlName="maquina" placeholder="N/A si no aplica">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Equipo</mat-label>
            <input matInput formControlName="equipo" placeholder="N/A si no aplica">
          </mat-form-field>
        </div>
      </div>

      <!-- PASO 5: Gestión del Cambio / Jerarquía de Controles -->
      <div class="step-content" *ngIf="currentStep === 4">
        <div class="section-header">
          <mat-icon>security</mat-icon>
          <h2>Gestión del Cambio / Jerarquía de Controles</h2>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Causa Raíz</mat-label>
          <textarea matInput formControlName="causaRaiz" rows="3" 
                    placeholder="Describa la causa raíz del accidente..."></textarea>
        </mat-form-field>

        <div class="controls-grid">
          <label class="control-card" [class.selected]="accidentForm.get('ctrlEliminacion')?.value">
            <mat-checkbox formControlName="ctrlEliminacion" color="primary"></mat-checkbox>
            <span class="control-letter">E</span>
            <span class="control-name">Eliminación</span>
          </label>

          <label class="control-card" [class.selected]="accidentForm.get('ctrlSustitucion')?.value">
            <mat-checkbox formControlName="ctrlSustitucion" color="primary"></mat-checkbox>
            <span class="control-letter">S</span>
            <span class="control-name">Sustitución</span>
          </label>

          <label class="control-card" [class.selected]="accidentForm.get('ctrlIngenieria')?.value">
            <mat-checkbox formControlName="ctrlIngenieria" color="primary"></mat-checkbox>
            <span class="control-letter">I</span>
            <span class="control-name">Ingeniería de Control</span>
          </label>

          <label class="control-card" [class.selected]="accidentForm.get('ctrlAdministracion')?.value">
            <mat-checkbox formControlName="ctrlAdministracion" color="primary"></mat-checkbox>
            <span class="control-letter">A</span>
            <span class="control-name">Administración</span>
          </label>

          <label class="control-card" [class.selected]="accidentForm.get('ctrlEPP')?.value">
            <mat-checkbox formControlName="ctrlEPP" color="primary"></mat-checkbox>
            <span class="control-letter epp">EPP</span>
            <span class="control-name">Equipo de Protección Personal</span>
          </label>
        </div>

        <div class="form-grid cols-2 mt-4">
          <mat-form-field appearance="outline">
            <mat-label>Estado *</mat-label>
            <mat-select formControlName="estado">
              <mat-option *ngFor="let est of estadoOptions" [value]="est">
                {{ est }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Observaciones</mat-label>
          <textarea matInput formControlName="observaciones" rows="3" 
                    placeholder="Observaciones adicionales..."></textarea>
        </mat-form-field>
      </div>

      <!-- Navegación entre pasos -->
      <div class="form-navigation">
        <button mat-stroked-button type="button" (click)="prevStep()" *ngIf="currentStep > 0">
          <mat-icon>arrow_back</mat-icon>
          Anterior
        </button>
        <span class="spacer"></span>
        <button mat-stroked-button type="button" (click)="onReset()" *ngIf="currentStep === 0">
          <mat-icon>refresh</mat-icon>
          Limpiar
        </button>
        <button mat-flat-button color="primary" type="button" (click)="nextStep()" 
                *ngIf="currentStep < 4" [disabled]="!isStepValid(currentStep)">
          Siguiente
          <mat-icon>arrow_forward</mat-icon>
        </button>
        <button mat-flat-button color="primary" type="submit" *ngIf="currentStep === 4"
                [disabled]="isLoading">
          <mat-icon>save</mat-icon>
          Guardar Registro
        </button>
      </div>
    </form>

    <div *ngIf="isLoading" class="loading-overlay">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Guardando...</p>
    </div>
  </mat-card>
</div>
