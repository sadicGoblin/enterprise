<div class="horizontal-calendar-container">
  <!-- Loading overlay -->
  <div *ngIf="isLoading" class="loading-overlay">
    <mat-spinner diameter="40"></mat-spinner>
    <span class="loading-text">Cargando planificación...</span>
  </div>

  <div class="horizontal-calendar-wrapper">
    <table class="horizontal-calendar-table mat-elevation-z2">
      <!-- Header Row -->
      <tr class="calendar-header-row weekday-row">
        <th class="fixed-first-column activity-column">Actividad</th>
        <th class="fixed-second-column periodicity-column">Período</th>
        <th
          *ngFor="let day of days"
          class="day-column"
          [ngClass]="{ 'weekend-column': isWeekend(day) }"
        >
          <div class="weekday-label">{{ getDayOfWeekAbbr(day) }}</div>
          <div class="day-number">{{ day < 10 ? "0" + day : day }}</div>
        </th>
        <th class="sticky-end-column">Asigna.</th>
        <th class="sticky-end-column">Realiz.</th>
        <th class="sticky-end-column">% Cump.</th>
      </tr>

      <!-- Group by ámbito and show activities -->
      <ng-container *ngFor="let group of groupedActivities">
        <!-- Group Header Row -->
        <tr class="ambito-header-row">
          <td class="fixed-full-width ambito-header" colspan="2">
            <mat-icon class="ambito-icon">arrow_right</mat-icon>
            Ámbito: {{ group.ambit }}
          </td>
          <td
            *ngFor="let day of days"
            class="day-column ambito-header-cell"
            [ngClass]="{ 'weekend-column': isWeekend(day) }"
          ></td>
          <td class="sticky-end-column ambito-header-cell"></td>
          <td class="sticky-end-column ambito-header-cell"></td>
          <td class="sticky-end-column ambito-header-cell"></td>
        </tr>

        <!-- Activities in this group -->
        <tr *ngFor="let activity of group.activities" class="calendar-row">
          <td class="fixed-first-column activity-column">
            <div class="activity-name-container">
              <div class="subprocess-line">{{ activity.subProcess }}</div>
              <div class="activity-line">{{ activity.activityName }}</div>
            </div>
          </td>
          <td class="fixed-second-column periodicity-column">
            {{ formatPeriodicity(activity.periodicity) }}
          </td>
          <td
            *ngFor="let day of days"
            class="day-column status-cell"
            [ngClass]="getCellClass(activity, day)"
          >
            <button
              mat-icon-button
              class="status-icon-button"
              [disabled]="!isActivityCompleted(activity, day)"
              (click)="onStatusClick(activity, day)"
              [matTooltip]="
                isActivityCompleted(activity, day)
                  ? 'Ver detalles de la actividad completada'
                  : ''
              "
            >
              <span
                class="material-symbols-outlined status-icon"
                [ngClass]="getStatusClass(activity, day)"
              >
                {{ getStatusIcon(activity, day) }}
              </span>
            </button>
          </td>
          <td class="sticky-end-column numeric-cell">
            {{ activity.assigned }}
          </td>
          <td class="sticky-end-column numeric-cell">
            {{ activity.realized }}
          </td>
          <td class="sticky-end-column numeric-cell compliance-cell">
            {{ activity.compliance }}%
          </td>
        </tr>
      </ng-container>

      <!-- Empty state when no data -->
      <tr *ngIf="groupedActivities.length === 0 && !isLoading" class="empty-row">
        <td [attr.colspan]="days.length + 5" class="empty-cell">
          <div class="empty-state">
            <mat-icon>event_busy</mat-icon>
            <span>No hay actividades para mostrar</span>
          </div>
        </td>
      </tr>

      <!-- Summary row with totals -->
      <tr class="summary-row" *ngIf="groupedActivities.length > 0">
        <td class="fixed-first-column total-column" colspan="2">TOTAL</td>
        <td
          *ngFor="let day of days"
          class="day-column summary-cell"
          [ngClass]="{ 'weekend-column': isWeekend(day) }"
        ></td>
        <td class="sticky-end-column numeric-cell total-cell">
          {{ totalAssigned }}
        </td>
        <td class="sticky-end-column numeric-cell total-cell">
          {{ totalRealized }}
        </td>
        <td class="sticky-end-column numeric-cell compliance-cell total-cell">
          {{ totalCompliancePercentage }}%
        </td>
      </tr>
    </table>
  </div>
</div>
