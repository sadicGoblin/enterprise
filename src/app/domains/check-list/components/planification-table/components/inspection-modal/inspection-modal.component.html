<div class="dialog-header">
  <h2 mat-dialog-title>Inspección SSTMA</h2>
  <button mat-icon-button class="close-button" (click)="onCancel()" matTooltip="Cerrar">
    <mat-icon>close</mat-icon>
  </button>
</div>

<div mat-dialog-content class="inspection-dialog-content">
  <form [formGroup]="inspectionForm">

    <div class="main-form-section">
      <div class="form-row">
        <mat-form-field appearance="outline" class="date-field">
          <mat-label>Fecha/Hora</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="date" placeholder="DD/MM/YYYY">
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="select-field">
          <mat-label>Realizado Por</mat-label>
          <input matInput formControlName="realizadoPor" readonly>
        </mat-form-field>

        <app-custom-select
          label="Asignación Responsable"
          [formControl]="responsableAsignadoControl"
          [loadFromApi]="true"
          [parameterType]="responsableParameterType"
          [customApiEndpoint]="'/ws/UsuarioSvcImpl.php'"
          [customApiRequestBody]="usuariosObraRequestBody"
          [customOptionValueKey]="'IdUsuario'"
          [customOptionLabelKey]="'nombre'"
          placeholder="Seleccionar Responsable"
          appearance="outline"
          class="select-field"
        ></app-custom-select>
      </div>
    </div>

    <div class="inspection-type-selector">
      <mat-radio-group formControlName="inspectionType" class="inspection-type-radio-group">
        <mat-radio-button value="programada" color="primary">Programada</mat-radio-button>
        <mat-radio-button value="informal" color="primary">Informal</mat-radio-button>
      </mat-radio-group>
      
      <mat-form-field appearance="outline" class="full-width observation-field" *ngIf="inspectionForm.get('inspectionType')?.value === 'informal'">
        <textarea matInput rows="4" formControlName="observation" placeholder="Ingrese su observación aquí"></textarea>
      </mat-form-field>
    </div>

    <section class="items-table-section">
      <h3>Inspección SSTMA</h3>
      
      <!-- Indicador de carga -->
      <div *ngIf="isLoadingInspeccion" class="spinner-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cargando datos de inspección...</p>
      </div>
      
      <!-- Mensaje de error -->
      <div *ngIf="!isLoadingInspeccion && errorLoadingInspeccion" class="error-message">
        <mat-icon color="warn">error</mat-icon>
        <p>{{errorLoadingInspeccion}}</p>
      </div>

      <!-- Sin datos -->
      <div *ngIf="!isLoadingInspeccion && !errorLoadingInspeccion && items.controls.length === 0" class="no-data-message">
        <p>No hay datos de inspección disponibles.</p>
      </div>

      <!-- Tabla HTML Estándar -->
      <div *ngIf="!isLoadingInspeccion && items.controls.length > 0" class="inspection-table-wrapper">
        <table class="inspection-table">
          <thead>
            <tr>
              <th class="action-column"></th>
              <th>Condición Riesgo</th>
              <th>Incidencia</th>
              <th>Potencial Riesgo</th>
              <th>Clasificación Hallazgo</th>
              <th>Medida Correctiva</th>
              <th>Responsable</th>
              <th>Fecha Compromiso</th>
              <th>Fecha Cierre</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of items.controls; let i = index">
              <td class="action-column">
                <button mat-icon-button color="primary" type="button" matTooltip="Ver imagen" 
                  (click)="mostrarImagenEnPopup(item.value.foto)" 
                  [disabled]="!item.value.foto">
                  <mat-icon>image</mat-icon>
                </button>
              </td>
              <td>{{item.value.condicionRiesgo || 'No disponible'}}</td>
              <td>{{item.value.incidencia || 'No disponible'}}</td>
              <td>{{item.value.potencialRiesgo || 'No disponible'}}</td>
              <td>{{item.value.clasificacionHallazgo || 'No disponible'}}</td>
              <td>{{item.value.medidaCorrectiva || 'No disponible'}}</td>
              <td>{{item.value.responsable || 'No disponible'}}</td>
              <td>{{item.value.fechaCompromisoFormateada || 'No disponible'}}</td>
              <td>{{item.value.fechaCierreFormateada || 'No disponible'}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </form>
</div>

<div mat-dialog-actions class="dialog-actions">
  <button mat-button class="exit-button" (click)="onCancel()">
    <mat-icon>exit_to_app</mat-icon> Salir
  </button>
  <div class="spacer"></div>
  <button mat-button class="pdf-button" (click)="saveAsPDF()">
    <span class="pdf-icon">PDF</span>
  </button>
  <button mat-raised-button color="primary" class="save-button" (click)="onSave()">
    <mat-icon>save</mat-icon> Grabar
  </button>
</div>
